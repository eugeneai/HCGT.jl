using HCGeoTherm
using Test
using DataFrames


# The CSV is expected to have columns T_C or T_K,   D_km or D_m or P_GPa, or P_kbar
function loadCSV(fileName :: String, canonify::Bool = false) :: DataFrame
    pt = CSV.read(fileName, DataFrame, delim=';', decimal=',')
    if canonify
        pt |> canonifyDF
    end
    pt
end


function run()::GTResult
    q0 = 33:1:40         # [mW/m^2] surface heat flow
    GP = defaultGTInit(q0, true)
    df = DataFrame()
    df.D_km = [158.710903731105, 197.151083128184, 197.251122983287, 185.994446480959,
               183.488962202311, 154.814392746081, 172.425902599515, 176.49693638962,
               177.049820011158, 189.505363587876, 177.474203046967, 163.064318238596,
               167.819399950392, 163.006385408149, 201.439577081904, 177.898370166463,
               167.982799770112, 184.173448881556, 190.139203901655, 173.079448494296,
               152.468008481004, 193.626638161674, 195.656821958049, 210.142871750405,
               205.133914433592, 196.741027433965, 134.807157912221, 177.191964187399,
               203.016840863789, 195.883479455291, 183.569177866399, 199.947537627705,
               200.308719317077, 194.641687001382, 163.401539235177, 200.308350637144,
               190.932034141031, 203.532192407734, 162.664954300405, 196.871999513546,
               206.618076684322, 139.242925847361, 181.238893685252, 163.733772214681,
               190.549264018394, 192.202711688092, 191.456332069311, 157.485969448231,
               195.339119457826, 156.75015879345, 191.338036279966, 197.078193698289,
               139.792398816189, 156.256131356791, 192.996304049587, 153.537899663964,
               180.216643480478, 197.636559586046, 196.335647064123, 188.131577682778,
               158.622954165593, 212.578827057428, 161.606149706605, 203.063081414167,
               159.37074251299, 203.074747192968, 175.181373183155, 175.569890987842,
               196.828398020998, 159.248180058634, 199.369480293558, 192.533524761738,
               162.28032347314, 195.171326727853, 169.446333248108, 174.464249321752,
               198.807518212374, 206.312995854559, 201.05436733025, 188.666256583969,
               186.218391114662, 202.027569880288, 204.789398531607, 201.249794801497,
               189.286047179308, 146.154653345132, 172.182114285409, 201.156673574266,
               169.476534739982, 82.6197402611039, 209.803763780677, 190.571216514938,
               199.95550093564, 191.052575387693, 208.83467221132, 187.554783496461,
               202.130572503727, 182.63788714092, 207.720012518563, 160.022056323552,
               160.727133810545, 193.610320118621, 164.273865998899, 187.451584284955,
               163.985472710692, 170.022709213618, 157.142871844242, 172.654317468949,
               194.038391465788, 98.8893299401402, 103.557831606833, 174.971777398963,
               148.660727394542, 206.031111843482, 195.537126917855, 169.535516382882,
               124.78450361138, 186.776682113804, 176.99766893251, 161.939380669625,
               186.415535751456, 208.933165118511, 203.797574977357, 197.593317947109,
               188.161937707694, 209.954539822265, 188.407378934256, 186.23571617109,
               186.26585288953, 154.590300377399, 159.751036464436, 194.307173738557,
               190.778658103604, 152.325466821656, 169.071382246519, 201.980099652999,
               173.163303269593, 149.927013655195, 153.061642048887, 195.901161059152,
               205.115954288482, 205.115954288482, 205.115954288482, 205.115954288482,
               205.115954288482, 205.115954288482, 205.115954288482, 205.115954288482,
               205.115954288482, 205.115954288482, 205.115954288482, 205.115954288482,
               205.115954288482, 205.115954288482, 136.401417126107, 150.483182813682,
               181.261243684439, 167.504533437088, 160.594298871933, 155.569446456898,
               159.252988596004, 147.152877755352, 154.945379143611, 146.499798658197,
               136.377813127873, 119.737185524359, 166.528834289278, 152.406537943073,
               173.802238421884, 149.391482081459, 163.20684068783, 136.119103858537,
               139.533630393928, 156.876093746339, 159.541381350203, 140.3300349184,
               154.21622666742, 169.156327763894, 148.439550813439, 160.154315829958,
               156.474547891618, 153.81944251141, 168.524468240905, 145.627221832882,
               159.340684072961, 155.46924210872, 159.340684072961, 155.46924210872]
    df.T_K = [1326.09689717222, 1462.07435289063, 1470.13815898029, 1389.56916401032,
              1398.44405986543, 1291.2390208183201, 1329.73756052909, 1343.10523924746,
              1356.32730426681, 1446.55853264579, 1351.04009236396, 1251.449129768458,
              1333.12617347408, 1305.58238092015, 1533.55884186947, 1405.51337252803,
              1390.02166352615, 1435.75728782991, 1439.17885082517, 1369.09266679515,
              1225.9269556110398, 1477.81968071425, 1480.23554380334, 1611.78855926772,
              1640.95429842309, 1500.93169847382, 1217.3511831983951, 1388.90431594903,
              1528.09899157878, 1457.23918959132, 1416.00735713008, 1579.62445534138,
              1613.85855396365, 1518.84576068614, 1331.75710854501, 1500.69943544761,
              1386.34780274204, 1501.01676336712, 1293.22489747374, 1466.2289294122,
              1602.60737431364, 1185.516002727902, 1425.06875571646, 1315.07568842355,
              1642.73486153715, 1483.63472860498, 1623.16856315794, 1283.55013338231,
              1504.69093000347, 1273.42005436252, 1421.43697831747, 1476.85114537032,
              1228.763445501881, 1271.6115472703132, 1437.01559661486, 1255.7265627267461,
              1396.60325534591, 1467.27919310404, 1619.52821877186, 1446.58984604735,
              1272.2115021464929, 1644.64763950755, 1281.30853019583, 1657.72702295943,
              1276.04261378001, 1532.48264884929, 1351.69722523754, 1356.27412272073,
              1466.93178379839, 1297.18922046196, 1485.2104151182, 1457.77085157784,
              1298.08170545023, 1641.87900678863, 1345.87116817202, 1381.92796723108,
              1489.29703440847, 1543.58308656209, 1593.68550972194, 1447.88492976256,
              1408.45055932826, 1601.90586902525, 1601.09841355417, 1578.08078160482,
              1402.20588325785, 1246.4160035023829, 1300.54500805487, 1518.25629692662,
              1287.8584556257101, 974.283234815639, 1640.39102976445, 1420.53445742354,
              1472.9658801564, 1454.21271135556, 1611.19571598011, 1457.20016710937,
              1635.99738317627, 1402.33504364282, 1624.23906123561, 1276.26187557898,
              1278.15138817174, 1462.83174918416, 1293.45011472034, 1444.77816112275,
              1279.7424956771902, 1338.03931900971, 1252.733345952754, 1350.23218473714,
              1602.25858173745, 1100.097850677308, 1035.582585781563, 1326.76764301102,
              1206.5356987505938, 1605.82939795507, 1468.59101982737, 1293.90261363005,
              1059.506943833279, 1469.0150636828, 1350.08268326551, 1299.37445892258,
              1430.17803493417, 1629.36677839287, 1604.90103327639, 1640.72734311094,
              1434.1467839307, 1630.85699379973, 1469.46357660138, 1404.72549185004,
              1438.98046547426, 1279.31793084547, 1315.79552577665, 1462.58570523471,
              1436.41614618449, 1256.752803957057, 1324.98981494276, 1569.68909312027,
              1324.62408043347, 1224.1820428575102, 1226.916652683597, 1649.45605842655,
              1508.75837444381, 1508.75837444381, 1508.75837444381, 1508.75837444381,
              1508.75837444381, 1508.75837444381, 1508.75837444381, 1508.75837444381,
              1508.75837444381, 1508.75837444381, 1508.75837444381, 1508.75837444381,
              1508.75837444381, 1508.75837444381, 1233.414358434794, 1205.510753113872,
              1391.36697932538, 1294.51665471778, 1307.62263021557, 1268.845174735663,
              1274.48346464936, 1217.661136788442, 1238.5438977933009, 1186.3659485643811,
              1227.4657176265218, 1247.71503735604, 1332.45550776663, 1226.801555627368,
              1374.86727118538, 1208.894689090683, 1328.85256967852, 1154.1958575860122,
              1224.390430350709, 1284.79407112556, 1284.73390003088, 1187.690289603675,
              1311.68679171934, 1361.2670257549, 1188.719203617944, 1276.0488796843301,
              1254.253678449365, 1269.486214317642, 1303.07156428477, 1190.9788194532111,
              1213.348543974523, 1251.097927279212, 1213.348543974523, 1251.097927279212]
    df = df |> canonifyDF # Added, e.g. T_C,
    computeGeotherm(GP, df)
end

@testset "Compute one geotherm without optimization" begin
    GP = defaultGTInit([35])
    P_GPa=[6.54]
    T_C=[1368]
    T_K=T_C .+ 273
    D_km=P_GPa |> depth
    df = DataFrame(P_GPa=P_GPa, T_C=T_C, T_K=T_K, D_km=D_km)
    answer = computeGeotherm(GP)
    T = answer.GT[1].T
    lT = T[length(T)]
    @test lT>1000
    @test lT<2000
end


@testset "Complex test all-in-one test" begin
    rc = run()
    @test length(rc.GT) == 8 # Reached here
    @test rc.GT_opt != nothing
    @test rc.ini.q0 == 33:1:40
end
